# ADR-002: Безопасная загрузка изображений (magic bytes, лимиты, UUID-имя)
Дата: 2025-10-21

## Context
Нужна безопасная обработка пользовательских загрузок: защита от DoS (большие файлы), от подмены формата (MIME spoofing), от path traversal и записи через симлинки. Формат загрузки - изображения PNG/JPEG.

## Decision
Реализовать минимальный валидатор и сохранение с безопасными практиками:
- `sniff_image_type(data)` проверяет **magic bytes**: PNG (`\x89PNG...`) и JPEG (SOI/EOI).
- Лимит размера: `MAX_BYTES = 5_000_000` (~= 5 МБ).
- Имя файла - **UUID** + расширение по типу; без использования пользовательского имени.
- Канонизация пути `Path.resolve()`; запрет симлинков в родительских каталогах.
- Функция сохранения: `secure_save(base_dir, data)`.

Точки реализации: `app/security/upload_secure.py`.

## Alternatives
- **Полагаться на Content-Type/расширение**: уязвимо к подмене, нет реальной проверки типа.
- **Image-библиотека (Pillow) для декодирования**: надёжнее, но тяжелее и медленнее для MVP.
- **Сохранение как есть**: минимальные трудозатраты, максимальные риски.

## Consequences
**Плюсы:** снижение риска RCE/poisoning; ограничение DoS-векторов (большие файлы).
**Минусы:** небольшой CPU-оверход на sniff; поддерживаем только PNG/JPEG.

## Security impact
- Уменьшаем вероятность загрузки «псевдо-изображений» (скрипты/архивы).
- Блокируем перезапись/выход за пределы каталога через traversal/симлинки.
- Контролируем потребление ресурсов за счёт жёсткого лимита размера.

## Rollout plan
1. Включить `secure_save` в эндпойнт загрузки (или использовать как библиотечную функцию в сервисе).
2. Обновить негативные тесты: «слишком большой файл», «неверный тип», «симлинк/трэвёрсал».
3. Добавить логирование write-операций (связь с NFR-07) и, при необходимости, базовый rate-limit (связь с NFR-08).
4. Документировать ограничения форматов и размера в README/Swagger.

## Links
- NFR: `docs/security-nfr/NFR.md`
- Threat model: `docs/threat-model/DFD.md`, `docs/threat-model/RISKS.md`, `docs/threat-model/STRIDE.md`
- Код: `app/security/upload_secure.py`
- Тесты: `tests/test_secure_upload.py`
- PR: ветка `p05-secure-coding`
