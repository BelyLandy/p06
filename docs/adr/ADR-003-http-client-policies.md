# ADR-003: Политики HTTP-клиента (таймауты, ретраи, лимиты)
Дата: 2025-10-21

## Context
Сервис делает исходящие HTTP-запросы (веб-хуки/интеграции). Нужно исключить «вечные» подвисания,
снизить шум ошибок при временных сбоях и не допускать перегрузки удалённой стороны.
Без явных политик клиенты по умолчанию могут ждать бесконечно и не ограничивать частоту.

## Decision
Вводим стандартизованные политики для всех исходящих HTTP-клиентов:
- **Таймауты:** `connect=2s`, `read=3s`, `total<=5s` (fail-fast).
- **Ретраи:** не более `2` повторов по таймаутам/временным сетевым ошибкам, backoff `100ms → 400ms`.
- **Лимиты:** к одному хосту — не более `N rps` (тонкий клиентский rate-limit).
- **Цепочка контекста:** пробрасываем `X-Request-ID` / `correlation_id` в исходящие запросы.
- **Ошибки:** таймауты/отказы маппим на RFC 7807 (см. ADR-001) через общий маппер.

Точки реализации:
- общий wrapper `app/utils/http_client.py` (единственная точка создания клиентов/сессий);
- маппинг ошибок — `app/utils/errors.py` (используется wrapper-ом).

## Alternatives
- **Без ретраев/таймаутов:** проще, но хвосты латенсий, блокировки, тяжёлая деградация.
- **Агрессивные ретраи (≥5):** лучше при флапах, но риск DoS партнёра и рост задержек.
- **Сайдкар/прокси (service mesh):** богаче контроль, но избыточно для учебного проекта.

## Consequences
**Плюсы:** предсказуемое поведение, быстрый фейл, меньше хвостов латенсий, контроль нагрузки.
**Минусы:** дополнительные ветки в обработке ошибок; редкие «ложные» отказы при жёстких таймаутах.

## Security impact
- Снижение поверхности DoS (нет «вечных» соединений).
- Сквозная трассировка инцидентов (проброс `correlation_id`).
- Соответствие нефункциональным требованиям по устойчивости/наблюдаемости.

## Rollout plan
1. Добавить `app/utils/http_client.py` с политиками (таймауты/ретраи/лимиты).
2. Запретить прямые вызовы HTTP-клиента (только через wrapper) — код-ревью/линтером.
3. Добавить тесты с моками: таймаут -> маппинг в RFC7807; ретраи с backoff.
4. Включить счётчики (ретраи/таймауты) и логирование с `correlation_id`.
5. Обновить README/доки по использованию wrapper-а.
6. Добавлен каркас app/utils/http_client.py; перевести исходящие вызовы на него.

## Links
- NFR: `docs/security-nfr/NFR.md`
- Threat model: `docs/threat-model/DFD.md`, `docs/threat-model/RISKS.md`, `docs/threat-model/STRIDE.md`
- Код: `app/utils/errors.py` (RFC7807 маппинг), `app/utils/http_client.py` (wrapper, будет добавлен)
- Тесты: `tests/test_errors.py` (маппинг), `tests/test_http_policies.py` (ретраи/таймауты, будет добавлен)
- Связанные ADR: `ADR-001-rfc7807-errors.md`
