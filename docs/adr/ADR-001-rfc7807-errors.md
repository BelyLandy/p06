# ADR-001: Единый формат ошибок RFC 7807
Дата: 2025-10-21

## Context
В API нужна единообразная подача ошибок: одинаковое тело ответа для 4xx/5xx, маскирование внутренних деталей и трассировка инцидентов по `correlation_id`.
Альтернативы: «самодельные» JSON-схемы, текстовые ответы, только HTTP-коды без тела.

## Decision
Принять формат RFC 7807: поля `type`, `title`, `status`, `detail`, `correlation_id`.
Реализовано helper-ом `problem(...)` и централизованными exception handlers.

- Код: `app/utils/errors.py` экспортирует `problem` и маппинг исключений.
- Все роуты FastAPI/Starlette используют эти хендлеры.
- Детали внутренних ошибок маскируются; в логи пишется trace с тем же `correlation_id`.

## Alternatives
- **Своя JSON-схема**: гибко, но нет совместимости и готовых инструментов.
- **Только HTTP-коды**: минимум работы, но теряется контекст/диагностика.
- **Готовые либы/фреймворки**: быстрее старт, но зависимость от сторонней реализации.

## Consequences
**Плюсы:** стабильный контракт для клиентов и автотестов; проще агрегировать логи/метрики; единый обработчик ошибок.
**Минусы:** небольшой оверхед на обёртку и поддержку маппинга исключений.

## Security impact
- Исключаем утечки внутренних деталей (стек-трейсы, пути, SQL-сообщения) во внешние ответы.
- Улучшаем расследуемость инцидентов через `correlation_id` и единый формат.

## Rollout plan
1. Включить хендлеры в `app/main.py` (инициализация приложения).
2. Прогнать существующие тесты на 404/422 и негативные кейсы.
3. Застолбить контракт в `tests/test_rfc7807.py` и добавить проверки в CI.
4. Запретить прямую отдачу сырых ответов в код-ревью.

## Links
- NFR: `docs/security-nfr/NFR.md`
- Threat model: `docs/threat-model/DFD.md`, `docs/threat-model/RISKS.md`, `docs/threat-model/STRIDE.md`
- Код: `app/utils/errors.py`, `app/main.py`
- Тесты: `tests/test_rfc7807.py`, `tests/test_errors.py`
- PR: ветка `p05-secure-coding`
